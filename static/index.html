<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Bear Planner</title>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>

    <link href="/static/style.css" rel="stylesheet"/>
</head>

<body>

<header>
    <h1>üêª Bear Planner</h1>
</header>

<!-- TOP TOOLBAR -->
<div class="toolbar">
    <button
            aria-controls="mapPanel"
            aria-label="Collapse map panel"
            aria-pressed="false"
            class="layout-toggle-btn"
            id="toggleMapBtn"
            type="button"
    >
        <span class="toggle-icon">üó∫Ô∏è</span>
        <span class="toggle-label">Collapse Map</span>
    </button>
    <button
            aria-controls="tablePanel"
            aria-label="Collapse table panel"
            aria-pressed="false"
            class="layout-toggle-btn"
            id="toggleTableBtn"
            type="button"
    >
        <span class="toggle-icon">üìã</span>
        <span class="toggle-label">Collapse Table</span>
    </button>
    <button id="jokeBtn">Tell me a joke</button>
    <button>Placeholder 4</button>
    <button class="secondary" id="howToBtn">How to Use</button>

</div>

<!-- LAYOUT CONTROLS - Always visible toggle buttons -->

<main id="layoutRoot">

    <!-- MAP PANEL -->
    <section class="map-panel" id="mapPanel">
        <div class="panel-header">
            <h2>Map</h2>
        </div>
        <div class="panel-body" id="mapPanelBody">
            <div class="canvas-column">
                <div class="canvas-actions">
                    <button id="autoPlaceBtn">Auto Place Castles</button>
                    <button id="moveAllOutOfWayBtn">Move All Out of Way</button>
                    <button id="downloadBtn">Download Map</button>
                    <button id="sendToR4Btn">Send to R4 on Discord</button>
                    <button id="sendToAnnouncementsBtn">Publish to Announcements
                    </button>
                    <label class="grid-toggle">
                        <input aria-label="Toggle grid visibility" checked
                               id="gridToggle" type="checkbox">
                        <span>Show Grid</span>
                    </label>
                    <div class="map-score" id="mapScoreDisplay">Map Score: ‚Äî</div>
                </div>

                <div class="canvas-wrap">
                    <div class="efficiency-legend" id="efficiencyLegend">

                    </div>
                    <canvas aria-label="Interactive map for castle placement"
                            height="1600" id="map"
                            width="1600"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- CASTLE PANEL -->
    <section class="castle-panel" id="tablePanel">
        <div class="panel-header">
            <h2>Castles</h2>
        </div>
        <div class="panel-body" id="tablePanelBody">
            <div class="castle-toolbar">
                <input
                        aria-label="Search castles"
                        autocomplete="off"
                        id="castleSearch"
                        placeholder="Search by ID, player, preference‚Ä¶"
                        type="search"
                />
                <!-- New: Dropdown to limit view to all or top N castles -->
                <select aria-label="Limit castles shown" id="castleLimit">
                    <option value="all">All Castles</option>
                    <option value="10">Top 10</option>
                    <option value="20">Top 20</option>
                    <option value="50">Top 50</option>
                    <!-- <option value="100">Top 100</option> -->
                </select>
                <button aria-label="Upload CSV file" id="uploadCsvBtn">Upload CSV
                </button>
                <button aria-label="Download CSV file" class="secondary"
                        id="downloadCsvBtn">Download CSV
                </button>
                <button id="addCastleBtn">Add Castle</button>
            </div>

            <!-- Bulk Operations Toolbar -->
            <div class="bulk-ops-toolbar" id="bulkOpsToolbar" style="display: none;">
                <span class="bulk-selection-count"
                      id="bulkSelectionCount">0 selected</span>
                <select aria-label="Select field to update" id="bulkField">
                    <option value="">Select field...</option>
                    <option value="player_level">Player Level</option>
                    <option value="command_centre_level">Command Centre Level</option>
                    <option value="preference">Preference</option>
                    <option value="locked">Locked Status</option>
                </select>
                <input id="bulkLevelValue" min="0" placeholder="New level"
                       style="display: none;" type="number"/>
                <select id="bulkPreferenceValue" style="display: none;">
                    <option value="BT1">BT1</option>
                    <option value="BT1/2">BT1/2</option>
                    <option value="BT2">BT2</option>
                    <option value="BT2/1">BT2/1</option>
                </select>
                <select id="bulkLockedValue" style="display: none;">
                    <option value="true">Locked</option>
                    <option value="false">Unlocked</option>
                </select>
                <button class="primary" id="applyBulkBtn">Apply to Selected</button>
                <button class="secondary" id="clearSelectionBtn">Clear Selection
                </button>
            </div>

            <div class="table-wrap">
                <table aria-label="Castle data table" class="castle-table"
                       id="castleTable" role="table">
                    <thead>
                    <tr>
                        <th class="checkbox-col">
                            <input aria-label="Select all castles"
                                   id="selectAllCheckbox" type="checkbox"/>
                        </th>
                        <th data-sort="id">ID</th>
                        <th data-sort="player">Player</th>
                        <th data-sort="power">Power</th>
                        <th data-sort="player_level">Lv</th>
                        <th data-sort="command_centre_level">CC</th>
                        <th data-sort="preference">Preference</th>
                        <th data-sort="locked">Locked</th>
                        <th data-sort="attendance">Attend</th>
                        <th data-sort="rallies_30min">Rallies/Session</th>
                        <th data-sort="round_trip">Round Trip Time (s)</th>
                        <th data-sort="priority_rank_100">Priority Rank</th>
                        <th data-sort="efficiency_score">Efficiency Score</th>
                        <th data-sort="last_updated">Last Updated</th>
                        <th>Delete</th>
                    </tr>
                    </thead>
                    <tbody id="castleTableBody">
                    <!-- Rows will be added via JS with data-id and hover/click handlers -->
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <button aria-label="Lock all placed castles" id="lockAllBtn">Lock All
                </button>
                <button aria-label="Unlock all castles" id="unlockAllBtn">Unlock All
                </button>
            </div>
        </div><!-- /.panel-body -->
    </section>

</main>

<input accept=".csv" aria-label="CSV file input" hidden id="csvUpload" type="file"/>


<!-- Castle Tooltip -->
<div aria-live="polite" id="castleTooltip"></div>

<!-- Toast Container -->
<div aria-live="polite" id="toastContainer"></div>

<footer>
    ¬© 2025 Matthew Picone ‚Äî All rights reserved | <span id="appVersion">Loading version...</span>
</footer>

<!-- Bulk Operation Confirmation Modal -->
<div id="bulkOperationModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 1px solid var(--border); padding: 20px; z-index: 10; border-radius: 8px; max-width: 400px;">
    <h3 id="bulkOperationTitle">Confirm Operation</h3>
    <p id="bulkOperationMessage">Are you sure you want to perform this bulk
        operation?</p>
    <div style="background: var(--surface); border-left: 4px solid var(--accent); padding: 12px; margin: 15px 0; border-radius: 4px;">
        <strong>‚ö†Ô∏è Important:</strong> Any castles you want to keep in their current
        positions should be
        <strong>locked</strong> before proceeding. Only unlocked castles will be moved.
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <button id="cancelBulkOperation" style="margin-right: 10px;">Cancel</button>
        <button id="confirmBulkOperation"
                style="background: var(--accent); color: white;">Proceed
        </button>
    </div>
</div>

<!-- Delete Modal -->
<div id="deleteModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 1px solid var(--border); padding: 20px; z-index: 10; border-radius: 8px;">
    <h3 id="deleteTitle">Delete Castle</h3>
    <label>Reason:</label>
    <select id="deleteReason">
        <option value="">Select reason</option>
        <option value="No longer in alliance">No longer in alliance</option>
        <option value="Created in error">Created in error</option>
        <option value="Other">Other</option>
    </select>
    <input id="deleteOther" placeholder="Please explain"
           style="display: none; margin-top: 10px; width: 100%;"
           type="text"/>
    <div style="margin-top: 20px; text-align: right;">
        <button id="cancelDelete">Cancel</button>
        <button id="confirmDelete">Delete</button>
    </div>
</div>

<!-- Add Castle Modal -->
<div id="addCastleModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 1px solid var(--border); padding: 20px; z-index: 10; border-radius: 8px; min-width: 350px;">
    <h3>Add New Castle</h3>
    <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Castle ID</label>
        <input id="addCastleId" placeholder="e.g., Castle 42 (leave empty to auto-generate)"
               style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);"
               type="text"/>
        <small style="color: var(--text-secondary); font-size: 0.85em;">Leave empty to auto-generate next available ID</small>
    </div>
    <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Player Name
            *</label>
        <input id="addCastleName" placeholder="Enter player name"
               style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);"
               type="text"/>
    </div>
    <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Discord Username</label>
        <input id="addCastleDiscord" placeholder="e.g., @username"
               style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);"
               type="text"/>
    </div>
    <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Power
            *</label>
        <input id="addCastlePower" placeholder="e.g., 25.5M or 25500000"
               style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);"
               type="text"/>
    </div>
    <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">TC Level
            *</label>
        <input id="addCastleLevel" max="50" min="1" placeholder="1-50"
               style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);"
               type="number"
               value="25"/>
    </div>
    <div style="margin: 15px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Bear
            Preference *</label>
        <select id="addCastlePreference"
                style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--surface); color: var(--text);">
            <option value="Both">Both</option>
            <option value="Bear 1">Bear 1</option>
            <option value="Bear 2">Bear 2</option>
        </select>
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <button id="cancelAddCastle" style="margin-right: 10px;">Cancel</button>
        <button id="confirmAddCastle" style="background: var(--accent); color: white;">
            Add Castle
        </button>
    </div>
</div>

<!-- Publish Confirmation Modal -->
<div id="publishConfirmModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 1px solid var(--border); padding: 20px; z-index: 10; border-radius: 8px; max-width: 420px;">
    <h3>Publish to Discord?</h3>
    <p>This will post the latest map to the Announcements channel for all members. Are
        you sure you want to publish?</p>
    <div style="background: var(--surface); border-left: 4px solid var(--accent); padding: 12px; margin: 15px 0; border-radius: 4px;">
        <strong>Heads up:</strong> This notifies everyone. Please confirm the map is
        final before publishing.
    </div>
    <div style="margin-top: 20px; text-align: right;">
        <button id="cancelPublish" style="margin-right: 10px;">Cancel</button>
        <button id="confirmPublish" style="background: var(--accent); color: white;">
            Publish
        </button>
    </div>
</div>

<!-- Joke Modal -->
<div id="jokeModal"
     style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel); border: 1px solid var(--border); padding: 20px; z-index: 10; border-radius: 8px; max-width: 500px;">
    <h3>Joke of the Day</h3>
    <p id="jokeSetup"></p>
    <div id="jokePunchline"
         style="display: none; margin-top: 15px; font-weight: bold;"></div>
    <div style="margin-top: 20px; text-align: right;">
        <button id="revealPunchline" style="background: var(--accent); color: white;">
            Reveal Punchline
        </button>
        <button id="closeJoke" style="margin-left: 10px;">Close</button>
    </div>
</div>

<script src="/static/toast.js"></script>
<script src="/static/sync.js"></script>
<script src="/static/app.js"></script>

</body>
</html>

